name: "Action to commit changes to the repository"
inputs:
  token:
    description: "GitHub token"
    required: true
outputs:
  sha:
    description: "SHA of generated commit"
    value: ${{ steps.commit.outputs.sha }}

runs:
  using: "composite"
  steps:
    - name: Check for changes
      id: check
      run: |
        set -x
        if [ -n "$(git status --porcelain)" ]; then
          echo "has_changes=true" | tee -a $GITHUB_OUTPUT
        else
          echo "has_changes=false" | tee -a $GITHUB_OUTPUT
        fi
      shell: bash

    - name: Determine repository state
      if: steps.check.outputs.has_changes == 'true'
      id: repo-state
      uses: ./.github/workflows/repo-state

    - name: Commit and create PR on protected branch
      if: steps.check.outputs.has_changes == 'true' && steps.repo-state.outputs.foreign == 'false' && steps.repo-state.outputs.protected == 'true'
      env:
        GITHUB_TOKEN: ${{ inputs.token }}
      run: |
        set -x
        current_branch=$(git branch --show-current)
        new_branch=gha-commit-$(git rev-parse --short HEAD)
        git checkout -b ${new_branch}
        git add .
        git commit -m "chore: Auto-update from GitHub Actions"$'\n'$'\n'"Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
        # Force-push, used in only one place
        # Alternative: separate branch names for each usage
        git push -u origin HEAD -f

        existing_pr=$(gh pr list --state open --base main --head ${new_branch} --json number --jq '.[] | .number')
        if [ -n "${existing_pr}" ]; then
          echo "Existing PR: ${existing_pr}"
        else
          gh pr create --base main --head ${new_branch} --title "chore: Auto-update from GitHub Actions" --body "Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
        fi

        gh workflow run rcc -f ref=$(git rev-parse HEAD)
        gh pr merge --merge --auto
      shell: bash

    - name: Commit and push on unprotected branch
      id: commit
      if: steps.check.outputs.has_changes == 'true' && steps.repo-state.outputs.foreign == 'false' && steps.repo-state.outputs.protected == 'false'
      env:
        GITHUB_TOKEN: ${{ inputs.token }}
      run: |
        set -x
        git fetch
        if [ -n "${GITHUB_HEAD_REF}" ]; then
          git add .
          git stash save
          git switch ${GITHUB_HEAD_REF}
          git merge origin/${GITHUB_BASE_REF} --no-edit
          git stash pop
        fi
        git add .
        git commit -m "chore: Auto-update from GitHub Actions"$'\n'$'\n'"Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
        git push -u origin HEAD

        # Only set output if changed
        echo sha=$(git rev-parse HEAD) >> $GITHUB_OUTPUT
      shell: bash

    - name: Create patch file for foreign branch
      if: steps.check.outputs.has_changes == 'true' && steps.repo-state.outputs.foreign == 'true'
      run: |
        set -x
        git diff > changes.patch
        echo "Patch file created with uncommitted changes"
        cat changes.patch
      shell: bash

    - name: Upload patch artifact
      if: steps.check.outputs.has_changes == 'true' && steps.repo-state.outputs.foreign == 'true'
      uses: actions/upload-artifact@v5
      with:
        name: changes-patch
        path: changes.patch

    - name: Add patch summary on foreign branch
      if: steps.check.outputs.has_changes == 'true' && steps.repo-state.outputs.foreign == 'true'
      run: |
        cat << 'EOF' >> $GITHUB_STEP_SUMMARY
        ## Formatting suggestions available

        A patch file with formatting suggestions has been generated. Since this PR is from a forked repository, the changes cannot be pushed automatically.

        You can apply the patch using one of these methods:

        ### Method 1: Apply via gh CLI

        ```bash
        # Download and apply the patch directly
        gh run download ${{ github.run_id }} --repo ${{ github.repository }} --name changes-patch && git apply changes.patch && rm changes.patch
        ```

        ### Method 2: Download from workflow artifacts

        1. Download the `changes-patch` artifact from this workflow run
        2. Extract and apply it:
           ```bash
           git apply changes.patch
           ```

        ### Method 3: View the patch

        <details>
        <summary>Click to see the patch contents</summary>

        ```diff
        EOF

        cat changes.patch >> $GITHUB_STEP_SUMMARY

        cat << 'EOF' >> $GITHUB_STEP_SUMMARY
        ```

        </details>
        EOF
      shell: bash

    - name: Fail on foreign branch
      if: steps.check.outputs.has_changes == 'true' && steps.repo-state.outputs.foreign == 'true'
      run: |
        echo "Exiting with failure due to foreign branch. Please apply the patch suggested in the action or PR comment."
        exit 1
      shell: bash
